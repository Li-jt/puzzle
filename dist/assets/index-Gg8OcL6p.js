var u=Object.defineProperty;var p=(c,s,t)=>s in c?u(c,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[s]=t;var o=(c,s,t)=>p(c,typeof s!="symbol"?s+"":s,t);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(e){if(e.ep)return;e.ep=!0;const i=t(e);fetch(e.href,i)}})();class z{constructor(s){o(this,"canvas");o(this,"ctx");this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=s.width,this.canvas.height=s.height,this.canvas.style.backgroundColor=s.backgroundColor||"white",s.container.appendChild(this.canvas)}getCanvas(){return this.canvas}getContext(){return this.ctx}}class f{constructor(s){o(this,"pieces",[]);o(this,"pieceWidth",0);o(this,"pieceHeight",0);o(this,"cols",3);o(this,"rows",3);o(this,"startTime",null);this.engine=s}createPuzzle(s){if(s){const t=this.engine.getCanvas();t.width=s.width,t.height=s.height,this.pieceWidth=s.width/this.cols,this.pieceHeight=s.height/this.rows,this.pieces=[];let a=0;for(let e=0;e<this.rows;e++)for(let i=0;i<this.cols;i++)this.pieces.push({index:++a,x:i*this.pieceWidth,y:e*this.pieceHeight,img:s,sx:i*this.pieceWidth,sy:e*this.pieceHeight,width:this.pieceWidth,height:this.pieceHeight});this.shufflePieces(),this.drawPuzzle(),this.startTime=Date.now()}}shufflePieces(){for(let s=this.pieces.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[this.pieces[s].x,this.pieces[t].x]=[this.pieces[t].x,this.pieces[s].x],[this.pieces[s].y,this.pieces[t].y]=[this.pieces[t].y,this.pieces[s].y]}}checkPuzzleCompletion(){for(let a of this.pieces)if(a.x!==a.sx||a.y!==a.sy)return!1;const t=(Date.now()-this.startTime)/1e3;return setTimeout(()=>{alert(`拼图完成！用时: ${t.toFixed(2)} 秒`)},500),!0}drawPuzzle(){const s=this.engine.getContext();s.clearRect(0,0,this.engine.getCanvas().width,this.engine.getCanvas().height),this.pieces.forEach(t=>{s.drawImage(t.img,t.sx,t.sy,t.width,t.height,t.x,t.y,t.width,t.height)})}}class m extends z{constructor(t,a,e,i="white"){super({container:t,width:a,height:e,backgroundColor:i});o(this,"draggedPiece",null);o(this,"offsetX",0);o(this,"offsetY",0);o(this,"originalX",0);o(this,"originalY",0);o(this,"puzzleManager");o(this,"throttledOnMouseMove",this.throttle(this.onMouseMove.bind(this),16));this.puzzleManager=new f(this);const d=document.createElement("input");d.type="file",d.accept="image/*",d.addEventListener("change",this.handleImageUpload.bind(this)),document.body.appendChild(d);const r=document.createElement("input");r.type="number",r.min="1",r.id="input1",r.value=this.puzzleManager.cols.toString(),r.addEventListener("blur",()=>{var l;this.puzzleManager.cols=parseInt(r.value,10),this.puzzleManager.createPuzzle((l=this.puzzleManager.pieces[0])==null?void 0:l.img)}),document.body.appendChild(r);const h=document.createElement("input");h.type="number",h.min="1",h.value=this.puzzleManager.rows.toString(),h.id="input2",h.addEventListener("blur",()=>{var l;this.puzzleManager.rows=parseInt(h.value,10),this.puzzleManager.createPuzzle((l=this.puzzleManager.pieces[0])==null?void 0:l.img)}),document.body.appendChild(h),this.getCanvas().addEventListener("mousedown",this.onMouseDown.bind(this)),this.getCanvas().addEventListener("mousemove",this.throttledOnMouseMove),this.getCanvas().addEventListener("mouseup",this.onMouseUp.bind(this))}handleImageUpload(t){var i;const e=(i=t.target.files)==null?void 0:i[0];if(e){const n=new FileReader;n.onload=d=>{var h;const r=new Image;r.src=(h=d.target)==null?void 0:h.result,r.onload=()=>{this.puzzleManager.createPuzzle(r)}},n.readAsDataURL(e)}}onMouseDown(t){const a=this.getCanvas().getBoundingClientRect(),e=t.clientX-a.left,i=t.clientY-a.top;for(let n of this.puzzleManager.pieces)if(e>=n.x&&e<=n.x+n.width&&i>=n.y&&i<=n.y+n.height){this.draggedPiece=n,this.offsetX=e-n.x,this.offsetY=i-n.y,this.originalX=n.x,this.originalY=n.y;break}}throttle(t,a){let e,i;return(...n)=>{i?(clearTimeout(e),e=setTimeout(()=>{Date.now()-i>=a&&(t.apply(this,n),i=Date.now())},a-(Date.now()-i))):(t.apply(this,n),i=Date.now())}}onMouseMove(t){if(this.draggedPiece){const a=this.getCanvas().getBoundingClientRect(),e=t.clientX-a.left,i=t.clientY-a.top;this.draggedPiece.x=e-this.offsetX,this.draggedPiece.y=i-this.offsetY,this.puzzleManager.drawPuzzle()}}onMouseUp(){if(this.draggedPiece){const t=Math.round(this.draggedPiece.x/this.puzzleManager.pieceWidth)*this.puzzleManager.pieceWidth,a=Math.round(this.draggedPiece.y/this.puzzleManager.pieceHeight)*this.puzzleManager.pieceHeight;let e=this.puzzleManager.pieces.find(i=>i.x===t&&i.y===a);if(e&&e!==this.draggedPiece){[this.draggedPiece.x,e.x]=[e.x,this.originalX],[this.draggedPiece.y,e.y]=[e.y,this.originalY];const i=this.puzzleManager.pieces.indexOf(this.draggedPiece),n=this.puzzleManager.pieces.indexOf(e);[this.puzzleManager.pieces[i],this.puzzleManager.pieces[n]]=[this.puzzleManager.pieces[n],this.puzzleManager.pieces[i]],this.puzzleManager.checkPuzzleCompletion()&&this.disableDragging()}else this.draggedPiece.x=this.originalX,this.draggedPiece.y=this.originalY;this.puzzleManager.drawPuzzle(),this.draggedPiece=null}}disableDragging(){this.getCanvas().removeEventListener("mousedown",this.onMouseDown.bind(this)),this.getCanvas().removeEventListener("mousemove",this.throttledOnMouseMove),this.getCanvas().removeEventListener("mouseup",this.onMouseUp.bind(this))}}const g=document.createElement("div");document.body.appendChild(g);new m(g,600,600);
